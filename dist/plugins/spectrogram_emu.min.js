!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):((e="undefined"!=typeof globalThis?globalThis:e||self).WaveSurfer=e.WaveSurfer||{},e.WaveSurfer.Spectrogram_emu=t())}(this,(function(){"use strict";class e{constructor(){this.listeners={}}on(e,t,i){if(this.listeners[e]||(this.listeners[e]=new Set),this.listeners[e].add(t),null==i?void 0:i.once){const i=()=>{this.un(e,i),this.un(e,t)};return this.on(e,i),i}return()=>this.un(e,t)}un(e,t){var i;null===(i=this.listeners[e])||void 0===i||i.delete(t)}once(e,t){return this.on(e,t,{once:!0})}unAll(){this.listeners={}}emit(e,...t){this.listeners[e]&&this.listeners[e].forEach((e=>e(...t)))}}class t extends e{constructor(e){super(),this.subscriptions=[],this.options=e}onInit(){}_init(e){this.wavesurfer=e,this.onInit()}destroy(){this.emit("destroy"),this.subscriptions.forEach((e=>e()))}}function i(e,t){const r=t.xmlns?document.createElementNS(t.xmlns,e):document.createElement(e);for(const[e,n]of Object.entries(t))if("children"===e)for(const[e,n]of Object.entries(t))"string"==typeof n?r.appendChild(document.createTextNode(n)):r.appendChild(i(e,n));else"style"===e?Object.assign(r.style,n):"textContent"===e?r.textContent=n:r.setAttribute(e,n.toString());return r}function r(e,t,r){const n=i(e,t||{});return null==r||r.appendChild(n),n}function n(e){e=e||window.Worker,this.url=this.getWorkerURL(),this.worker=new e(this.url)}n.prototype={getWorkerScript:function(){var e="";return e+="("+this.workerInit+")(this);"},workerInit:function(e){e.executed=!1,e.PI=3.141592653589793,e.TWO_PI=6.283185307179586,e.totalMax=0,e.dynRangeInDB=50,e.myWindow={BARTLETT:1,BARTLETTHANN:2,BLACKMAN:3,COSINE:4,GAUSS:5,HAMMING:6,HANN:7,LANCZOS:8,RECTANGULAR:9,TRIANGULAR:10},e.imgWidth=0,e.imgHeight=0,e.upperFreq=0,e.lowerFreq=0,e.pixelRatio=1,e.heatMapColorAnchors=[[255,0,0],[0,255,0],[0,0,0]],e.samplesPerPxl=0,e.sampleRate=0,e.preEmphasisFilterFactor=.97,e.transparency=0,e.drawHeatMapColors=!1,e.N=0,e.windowSizeInSecs=.01,e.audioBuffer=void 0,e.audioBufferChannels=0,e.wFunction=0,e.myFFT=void 0,e.pixelHeight=1,e.internalalpha=1,e.maxPsd=0,e.HzStep=0,e.paint=[],e.sin=void 0,e.cos=void 0,e.ceilingFreqFftIdx=0,e.floorFreqFftIdx=0,e.resultImgArr=void 0,e.toLinearLevel=function(e){return Math.pow(10,e/10)},e.log10=function(e){return Math.log(e)/2.302585092994046},e.magnitude=function(e,t){return Math.sqrt(e*e+t*t)},e.FFT=function(){var t,i,r,n=e.N;if(t=parseInt(Math.log(n)/.6931471805599453,10),void 0===e.cos||n!==e.N)for(e.cos=new Float32Array(n/2),r=0;r<n/2;r++)e.cos[r]=Math.cos(-2*e.PI*r/n);if(void 0===e.sin||n!==e.N)for(e.sin=new Float32Array(n/2),r=0;r<n/2;r++)e.sin[r]=Math.sin(-2*e.PI*r/n);this.applyWindowFuncAndPreemph=function(t,r,n,a){switch(this.alpha=r,t){case e.myWindow.BARTLETT:for(i=0;i<a;i++)i>0&&(n[i]=this.applyPreEmph(n[i],n[i-1])),n[i]*=this.wFunctionBartlett(a,i);break;case e.myWindow.BARTLETTHANN:for(i=0;i<a;i++)i>0&&(n[i]=this.applyPreEmph(n[i],n[i-1])),n[i]*=this.wFunctionBartlettHann(a,i);break;case e.myWindow.BLACKMAN:for(this.alpha=this.alpha||.16,i=0;i<a;i++)i>0&&(n[i]=this.applyPreEmph(n[i],n[i-1])),n[i]*=this.wFunctionBlackman(a,i,r);break;case e.myWindow.COSINE:for(i=0;i<a;i++)i>0&&(n[i]=this.applyPreEmph(n[i],n[i-1])),n[i]*=this.wFunctionCosine(a,i);break;case e.myWindow.GAUSS:for(this.alpha=this.alpha||.25,i=0;i<a;i++)i>0&&(n[i]=this.applyPreEmph(n[i],n[i-1])),n[i]*=this.wFunctionGauss(a,i,r);break;case e.myWindow.HAMMING:for(i=0;i<a;i++)i>0&&(n[i]=this.applyPreEmph(n[i],n[i-1])),n[i]*=this.wFunctionHamming(a,i);break;case e.myWindow.HANN:for(i=0;i<a;i++)i>0&&(n[i]=this.applyPreEmph(n[i],n[i-1])),n[i]*=this.wFunctionHann(a,i);break;case e.myWindow.LANCZOS:for(i=0;i<a;i++)i>0&&(n[i]=this.applyPreEmph(n[i],n[i-1])),n[i]*=this.wFunctionLanczos(a,i);break;case e.myWindow.RECTANGULAR:for(i=0;i<a;i++)i>0&&(n[i]=this.applyPreEmph(n[i],n[i-1])),n[i]*=this.wFunctionRectangular(a,i);break;case e.myWindow.TRIANGULAR:for(i=0;i<a;i++)i>0&&(n[i]=this.applyPreEmph(n[i],n[i-1])),n[i]*=this.wFunctionTriangular(a,i)}return n},this.wFunctionBartlett=function(e,t){return 2/(e-1)*((e-1)/2-Math.abs(t-(e-1)/2))},this.wFunctionBartlettHann=function(t,i){return.62-.48*Math.abs(i/(t-1)-.5)-.38*Math.cos(e.TWO_PI*i/(t-1))},this.wFunctionBlackman=function(t,i,r){var n=r/2;return(1-r)/2-.5*Math.cos(e.TWO_PI*i/(t-1))+n*Math.cos(4*e.PI*i/(t-1))},this.wFunctionCosine=function(t,i){return Math.cos(e.PI*i/(t-1)-e.PI/2)},this.wFunctionGauss=function(e,t,i){return Math.pow(Math.E,-.5*Math.pow((t-(e-1)/2)/(i*(e-1)/2),2))},this.wFunctionHamming=function(t,i){return.54-.46*Math.cos(e.TWO_PI*i/(t-1))},this.wFunctionHann=function(t,i){return.5*(1-Math.cos(e.TWO_PI*i/(t-1)))},this.wFunctionLanczos=function(t,i){var r=2*i/(t-1)-1;return Math.sin(e.PI*r)/(e.PI*r)},this.wFunctionRectangular=function(){return 1},this.wFunctionTriangular=function(e,t){return 2/e*(e/2-Math.abs(t-(e-1)/2))},this.applyPreEmph=function(t,i){return t-e.preEmphasisFilterFactor*i},this.fft=function(i,r){var a,s,o,h,l,p,c,d,u,w;for(s=0,l=n/2,a=1;a<n-1;a++){for(h=l;s>=h;)s-=h,h/=2;a<(s+=h)&&(u=i[a],i[a]=i[s],i[s]=u,u=r[a],r[a]=r[s],r[s]=u)}for(h=0,l=1,a=0;a<t;a++)for(h=l,l+=l,p=0,s=0;s<h;s++)for(c=e.cos[p],d=e.sin[p],p+=1<<t-a-1,o=s;o<n;o+=l)u=c*i[o+h]-d*r[o+h],w=d*i[o+h]+c*r[o+h],i[o+h]=i[o]-u,r[o+h]=r[o]-w,i[o]=i[o]+u,r[o]=r[o]+w}},e.convertToHeatmap=function(e,t,i,r){var n=r.length-1,a=(i-e)/(t-e)*n,s=Math.floor(a),o=Math.min.apply(null,[Math.floor(a)+1,n]),h=r[s],l=r[o],p=a-s;return{r:Math.floor(h[0]+p*(l[0]-h[0])),g:Math.floor(h[1]+p*(l[1]-h[1])),b:Math.floor(h[2]+p*(l[2]-h[2]))}},e.drawVerticalLineOfSpectogram=function(t){var i,r,n=e.pixelHeight,a=2*Math.pow(e.paint[t][1],2)/e.N,s=10*e.log10(a/e.maxPsd),o=(s+e.dynRangeInDB)/e.dynRangeInDB;o>1?o=1:o<0&&(o=0);for(var h=0;h<e.paint[t].length;h++){var l=o;a=2*Math.pow(e.paint[t][h],2)/e.N,(o=((s=10*e.log10(a/e.maxPsd))+e.dynRangeInDB)/e.dynRangeInDB)>1&&(o=1),o<0&&(o=0);var p=o;if(e.pixelHeight>=1)for(var c=0;c<e.pixelHeight;c++){var d=l+(p-l)/n*c;if(i=e.invert?Math.round(255*d):255-Math.round(255*d),r=4*(Math.floor(t)+Math.floor(e.imgHeight-(e.pixelHeight*(h-2)+c))*e.imgWidth),e.drawHeatMapColors)if(isNaN(i))e.resultImgArr[r+0]=i,e.resultImgArr[r+1]=i,e.resultImgArr[r+2]=i,e.resultImgArr[r+3]=e.transparency;else{var u=e.convertToHeatmap(0,255,i,e.heatMapColorAnchors);e.resultImgArr[r+0]=u.r,e.resultImgArr[r+1]=u.g,e.resultImgArr[r+2]=u.b,e.resultImgArr[r+3]=e.transparency}else e.resultImgArr[r+0]=i,e.resultImgArr[r+1]=i,e.resultImgArr[r+2]=i,e.resultImgArr[r+3]=e.transparency}else i=255-Math.round(255*p),r=4*(Math.floor(t)+Math.floor(e.imgHeight-e.pixelHeight*(h-2))*e.imgWidth),e.resultImgArr[r+0]=i,e.resultImgArr[r+1]=i,e.resultImgArr[r+2]=i,e.resultImgArr[r+3]=e.transparency}},e.calcMagnitudeSpectrum=function(t,i){for(var r=new Float32Array(e.N),n=new Float32Array(e.N),a=new Float32Array(e.ceilingFreqFftIdx-e.floorFreqFftIdx),s=0;s<i;s++)n[s]=e.audioBuffer[t+s];e.myFFT.applyWindowFuncAndPreemph(e.wFunction,e.internalalpha,n,i),e.myFFT.fft(n,r);for(var o=0;o<=e.ceilingFreqFftIdx-e.floorFreqFftIdx;o++)a[o]=e.magnitude(n[o+e.floorFreqFftIdx],r[o+e.floorFreqFftIdx]),e.totalMax<a[o]&&(e.totalMax=a[o]);return a},e.renderSpectrogram=function(){if(!e.executed){e.executed=!0;var t=e.sampleRate*e.windowSizeInSecs;e.myFFT=new e.FFT,e.paint=new Array(e.imgWidth),e.HzStep=e.sampleRate/2/(e.N/2),e.ceilingFreqFftIdx=Math.ceil(e.upperFreq/e.HzStep),e.floorFreqFftIdx=Math.floor(e.lowerFreq/e.HzStep),e.pixelHeight=e.imgHeight/(e.ceilingFreqFftIdx-e.floorFreqFftIdx-2),"undefined"==typeof Uint8ClampedArray&&(Uint8ClampedArray=Uint8Array),e.resultImgArr=new Uint8ClampedArray(Math.ceil(e.imgWidth*e.imgHeight*4));for(var i=0;i<e.imgWidth;i++)e.paint[i]=e.calcMagnitudeSpectrum(Math.round(i*e.samplesPerPxl),t),e.maxPsd=2*Math.pow(e.totalMax,2)/e.N;for(var r=0;r<e.imgWidth;r++)e.drawVerticalLineOfSpectogram(r);e.postMessage({window:e.wFunction,samplesPerPxl:e.samplesPerPxl,pixelHeight:e.pixelHeight,pixelRatio:e.pixelRatio,width:e.imgWidth,height:e.imgHeight,img:e.resultImgArr.buffer},[e.resultImgArr.buffer]),e.myFFT=null,e.executed=!1}},e.onmessage=function(t){if(void 0!==t.data){var i=!0,r="",n=t.data;if(void 0!==n.windowSizeInSecs?e.windowSizeInSecs=n.windowSizeInSecs:(r="windowSizeInSecs",i=!1),void 0!==n.fftN?e.N=n.fftN:(r="fftN",i=!1),void 0!==n.alpha?e.internalalpha=n.alpha:(r="alpha",i=!1),void 0!==n.upperFreq?e.upperFreq=n.upperFreq:(r="upperFreq",i=!1),void 0!==n.lowerFreq?e.lowerFreq=n.lowerFreq:(r="lowerFreq",i=!1),void 0!==n.samplesPerPxl?e.samplesPerPxl=n.samplesPerPxl:(r="samplesPerPxl",i=!1),void 0!==n.window)switch(n.window){case 1:e.wFunction=e.myWindow.BARTLETT;break;case 2:e.wFunction=e.myWindow.BARTLETTHANN;break;case 3:e.wFunction=e.myWindow.BLACKMAN;break;case 4:e.wFunction=e.myWindow.COSINE;break;case 5:e.wFunction=e.myWindow.GAUSS;break;case 6:e.wFunction=e.myWindow.HAMMING;break;case 7:e.wFunction=e.myWindow.HANN;break;case 8:e.wFunction=e.myWindow.LANCZOS;break;case 9:e.wFunction=e.myWindow.RECTANGULAR;break;case 10:e.wFunction=e.myWindow.TRIANGULAR}else r="window",i=!1;void 0!==n.imgWidth?e.imgWidth=n.imgWidth:(r="imgWidth",i=!1),void 0!==n.imgHeight?e.imgHeight=n.imgHeight:(r="imgHeight",i=!1),void 0!==n.dynRangeInDB?e.dynRangeInDB=n.dynRangeInDB:(r="dynRangeInDB",i=!1),void 0!==n.pixelRatio?e.pixelRatio=n.pixelRatio:(r="pixelRatio",i=!1),void 0!==n.sampleRate?e.sampleRate=n.sampleRate:(r="sampleRate",i=!1),void 0!==n.audioBufferChannels?e.audioBufferChannels=n.audioBufferChannels:(r="audioBufferChannels",i=!1),void 0!==n.transparency?e.transparency=n.transparency:(r="transparency",i=!1),void 0!==n.audioBuffer?e.audioBuffer=n.audioBuffer:(r="audioBuffer",i=!1),void 0!==n.drawHeatMapColors?e.drawHeatMapColors=n.drawHeatMapColors:(r="drawHeatMapColors",i=!1),void 0!==n.preEmphasisFilterFactor?e.preEmphasisFilterFactor=n.preEmphasisFilterFactor:(r="preEmphasisFilterFactor",i=!1),void 0!==n.heatMapColorAnchors?e.heatMapColorAnchors=n.heatMapColorAnchors:(r="heatMapColorAnchors",i=!1),void 0!==n.invert?e.invert=n.invert:(r="invert",i=!1),i?e.renderSpectrogram():e.postMessage({status:{type:"ERROR",message:r+" is undefined"}})}else e.postMessage({status:{type:"ERROR",message:"Undefined message was sent to spectroDrawingWorker"}})}},getWorkerURL:function(){var e;try{e=new Blob([this.getWorkerScript()],{type:"application/javascript"})}catch(t){window.BlobBuilder=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder,(e=new BlobBuilder).append(n),e=e.getBlob()}return"object"!=typeof URL&&"undefined"!=typeof webkitURL?webkitURL.createObjectURL(e):URL.createObjectURL(e)},kill:function(){this.worker&&this.worker.terminate(),this.url&&("object"!=typeof URL&&"undefined"!=typeof webkitURL?webkitURL.revokeObjectURL(this.url):URL.revokeObjectURL(this.url))},tell:function(e){this.worker&&this.worker.postMessage(e)},says:function(e){this.worker&&this.worker.addEventListener("message",(function(t){e(t.data)}))}};const a={insertPosition:"afterend",height:100,channel:0,windowSizeInSecs:.005,lowerFreq:0,alpha:.16,window:"hamming",dynRangeInDB:70,preEmphasisFilterFactor:.97,transparency:255,drawHeatMapColors:!1,heatMapColorAnchors:[[255,0,0],[0,255,0],[0,0,0]],invert:!1};class s extends t{static create(e){return new s(e||{})}constructor(e){switch(super(e||{}),this.options=Object.assign({},a,e),this.windowNum=6,this.options.window){case"bartlett":this.windowNum=1;break;case"bartletthann":this.windowNum=2;break;case"blackman":this.windowNum=3;break;case"cosine":this.windowNum=4;break;case"gauss":this.windowNum=5;break;case"hamming":this.windowNum=6;break;case"hann":this.windowNum=7;break;case"lanczos":this.windowNum=8;break;case"rectangular":this.windowNum=9;break;case"triangular":this.windowNum=10;break;default:throw new Error("Unknown window type: "+this.options.window)}this.createWrapper(),this.createCanvas(),this.imageData=this.spectrCc.createImageData(this.canvas.width,this.canvas.height),this.spectroWorker=new n,this.update_needed=!1,this.old_sS=-1,this.old_eS=-1,this.terminated=!1}onInit(){var e,t;if(!this.wavesurfer)throw Error("WaveSurfer is not initialized");this.options.container?("string"==typeof this.options.container?this.container=document.querySelector(this.options.container):this.options.container instanceof HTMLElement&&(this.container=this.options.container),null===(e=this.container)||void 0===e||e.appendChild(this.wrapper)):(this.container=this.wavesurfer.getWrapper().parentElement,null===(t=this.container)||void 0===t||t.insertAdjacentElement(this.options.insertPosition,this.wrapper)),this.spectroWorker.says((e=>{this.imageData.width==this.canvas.width&&this.imageData.height==this.canvas.height||(this.imageData=this.spectrCc.createImageData(this.canvas.width,this.canvas.height));let t=new Uint8ClampedArray(e.img);this.imageData.data.set(t),this.spectrCc.putImageData(this.imageData,0,0),window.requestAnimationFrame((()=>{this.render()}))})),this.subscriptions.push(this.wavesurfer.on("redraw",(()=>{this.update_needed=!0}))),this.subscriptions.push(this.wavesurfer.on("scroll",(()=>{this.update_needed=!0}))),this.subscriptions.push(this.wavesurfer.on("ready",(()=>{this.update_needed=!0}))),window.requestAnimationFrame((()=>{this.render()}))}destroy(){this.terminated=!0,this.unAll(),this.wavesurfer=null,this.util=null,this.options=null,this.wrapper&&(this.wrapper.remove(),this.wrapper=null),this.spectroWorker.kill(),this.spectroWorker=null,super.destroy()}createWrapper(){this.wrapper=r("div",{part:"spectrogram-emu",style:{width:"100%",height:this.options.height+"px"}}),this.wrapper.addEventListener("click",this._onWrapperClick)}createCanvas(){this.canvas=r("canvas",{style:{position:"relative",width:"100%",height:"100%"}},this.wrapper),this.spectrCc=this.canvas.getContext("2d")}calcClosestPowerOf2Gt(e){for(var t=0;Math.pow(2,t)<e;)t+=1;return Math.pow(2,t)}render(){if(this.terminated)return;if(!this.update_needed)return void window.requestAnimationFrame((()=>{this.render()}));const{scrollLeft:e,scrollWidth:t,clientWidth:i}=this.wavesurfer.renderer.scrollContainer,r=this.wavesurfer.getDecodedData();if(!r)return this.update_needed=!1,void window.requestAnimationFrame((()=>{this.render()}));let n=r.length,a=Math.floor(e/t*n),s=Math.floor((e+i)/t*n);if(a==this.old_sS&&s==this.old_eS)return this.update_needed=!1,void window.requestAnimationFrame((()=>{this.render()}));this.update_needed=!1,this.old_sS=a,this.old_eS=s,this.canvas.height=this.wrapper.offsetHeight,this.canvas.width=this.wrapper.offsetWidth;let o=r.getChannelData(this.options.channel),h=r.sampleRate,l=this.options.windowSizeInSecs;var p=this.calcClosestPowerOf2Gt(h*l);p<512&&(p=512);let c=l*h,d=(s+1-a)/this.canvas.width,u=o.subarray(a,s),w=[],m=[];a>c/2&&(w=o.subarray(a-c/2,a)),s+p/2-1<o.length&&(m=o.subarray(s,s+p/2-1));let f=new Float32Array(w.length+u.length+m.length);f.set(w),f.set(u,w.length),f.set(m,w.length+u.length);let g=h/2;this.options.upperFreq&&(g=this.options.upperFreq),this.spectroWorker.tell({windowSizeInSecs:l,fftN:p,alpha:this.options.alpha,upperFreq:g,lowerFreq:this.options.lowerFreq,samplesPerPxl:d,window:this.windowNum,imgWidth:this.canvas.width,imgHeight:this.canvas.height,dynRangeInDB:this.options.dynRangeInDB,pixelRatio:window.devicePixelRatio,sampleRate:h,transparency:this.options.transparency,audioBuffer:f,audioBufferChannels:1,drawHeatMapColors:this.options.drawHeatMapColors,preEmphasisFilterFactor:this.options.preEmphasisFilterFactor,heatMapColorAnchors:this.options.heatMapColorAnchors,invert:this.options.invert},[f.buffer])}}return s}));
